-*- mode: org -*-
* Introduction
This README documents setting up Arch Linux on an virpus.com openvz server
* Step by Step (successful Friday June 15, 2012 i686) [0/18]
1. [ ] Install Arch Linux ([[http://manage.virpus.com/login.php]])
2. [ ] Set root password
3. [ ] To facilitate upgrading glibc, add [openvz-tdw] repository to [[/etc/pacman.conf]]
   [[file://ssh:root@troywill.com:/etc/pacman.conf]]
   #+begin_src 
[openvz-tdw]
Server = http://packages.shilohsystem.com/openvz-tdw/i686
# Server = http://packages.shilohsystem.com/openvz-tdw/x86_64
   #+end_src
4. [ ] (Optional) Edit /etc/pacman.d/mirrorlist
   [[file://ssh:root@troywill.com:/etc/pacman.d/mirrorlist]]
5. [ ] Run "pacman -Sy" as root to refresh package lists
   #+begin_src sh
pacman -Sy
   #+end_src
6. [ ] Run "pacman -S --force pacman" to upgrade pacman
   #+begin_src 
pacman -S --force pacman   
   #+end_src
7. [ ] Run "pacman-db-upgrade" to update the pacman database format
   #+begin_src 
pacman-db-upgrade
   #+end_src
8. [ ] Copy /etc/pacman.conf.pacnew to /etc/pacman.conf
   #+begin_src 
cp /etc/pacman.conf.pacnew /etc/pacman.conf
   #+end_src
9. [ ] Run  `pacman-key --init; pacman-key --populate archlinux`
       to import the data required by pacman for package verification.
       See: https://www.archlinux.org/news/having-pacman-verify-packages
   #+begin_src 
pacman-key --init
pacman-key --populate archlinux
   #+end_src
10. [ ] Edit pacman.conf to temporarily turn off package signing
    
    Explanation: pacman will crash with package signing without upgrading an (not yet known) library with
    this error: `pacman: symbol lookup error: /usr/lib/libgpgme.so.11: undefined symbol: gpg_err_set_errno`
    [[file://ssh:root@troywill.com:/etc/pacman.conf]]
   #+begin_src
[core]
SigLevel = PackageRequired
SigLevel = Never
Include = /etc/pacman.d/mirrorlist

[extra]
SigLevel = PackageRequired
SigLevel = Never
Include = /etc/pacman.d/mirrorlist

#[community-testing]
#SigLevel = PackageRequired
#Include = /etc/pacman.d/mirrorlist

[community]
SigLevel = PackageRequired
SigLevel = Never
Include = /etc/pacman.d/mirrorlist
   #+end_src
11. [ ] Add [openvz-tdw] repository again to the new /etc/pacman.conf as in step 3
      [[file://ssh:root@troywill.com:/etc/pacman.conf]]
      #+begin_src 
  [openvz-tdw]
  Server = http://packages.shilohsystem.com/openvz-tdw/$arch
      #+end_src
12. [ ] Run "pacman -Sy" again to refresh package lists
    #+begin_src sh
pacman -Sy
    #+end_src
13. [ ] Run "pacman -S --force initscripts" to upgrade the initscripts package
    ( See https://www.archlinux.org/news/initscripts-update-manual-intervention-required/ for details )
    #+begin_src 
pacman -S --force initscripts
    #+end_src
14. [ ] Run "pacman -S --force filesystem" to upgrade the filesystem package
	( See http://www.archlinux.org/news/filesystem-upgrade-manual-intervention-required/ for details )
    #+begin_src 
pacman -S --force filesystem
    #+end_src
    NOTE: inaccurate error message => `error: extract: not overwriting dir with file var/run
          error: problem occurred while upgrading filesystem
          error: could not commit transaction
          error: failed to commit transaction (transaction aborted)
          Errors occurred, no packages were upgraded.`
	  
	  In fact, the package was upgraded

    NOTE: pacman: symbol lookup error: /usr/lib/libgpgme.so.11: undefined symbol: gpg_err_set_errno
15. [ ] Run "pacman -S --force krb5
16. [ ] Run "pacman -Su" to upgrade the system
    #+begin_src 
pacman -Su
    #+end_src
17. [ ] Run "pacman -S inetutils"
    #+begin_src 
pacman -S inetutils
    #+end_src
18. [ ] Reboot    
* Upgrading glibc
** Primary documentation
1. [[http://wiki.openvz.org/Archlinux_Template_creation][http://wiki.openvz.org/Archlinux_Template_creation]]
2. [[https://wiki.archlinux.org/index.php/VPS#Old_kernel_and_a_broken_system_with_OpenVZ][https://wiki.archlinux.org/index.php/VPS#Old_kernel_and_a_broken_system_with_OpenVZ]]
3. [[https://bbs.archlinux.org/viewtopic.php?pid=1044707][https://bbs.archlinux.org/viewtopic.php?pid=1044707]]
** Secondary documentation
1. [[http://wiki.gotux.net/archlinux/tutorials/openvz-vps-install][http://wiki.gotux.net/archlinux/tutorials/openvz-vps-install]]
* Developer Notes
** How to make a glibc package
1. [ ] install abs (pacman --sync abs)
2. [ ] run abs ( /usr/bin/abs )
3. [ ] copy /var/abs/glibc to a build directory
4. [ ] change pkgrel variable in PKGBUILD
5. [ ] change --enable-kernel flag in PKGBUILD to 2.6.18
6. [ ] run makepkg PKGBUILD
** How to set up a custom repository
[openvz-tdw]
Server = http://packages.shilohsystem.com/openvz-tdw
mkdir /srv/http/packages/openvz-tdw
#+begin_src sh
#!/bin/sh
PATH_TO_DB="/srv/http/packages/openvz-tdw/openvz-tdw.db.tar.gz"
PACKAGE="/srv/http/packages/openvz-tdw/glibc-2.15-100-i686.pkg.tar.xz"
repo-add ${PATH_TO_DB} ${PACKAGE}
#+end_src
==> Adding package '/srv/http/packages/openvz-tdw/glibc-2.15-100-i686.pkg.tar.xz'
  -> Computing checksums...
  -> Creating 'desc' db entry...
  -> Creating 'depends' db entry...
==> Creating updated database file '/srv/http/packages/openvz-tdw/openvz-tdw.db.tar.gz'

1. repo-add /srv/http/packages/openvz/glibc-vps/i686/glibc-openvz.db.tar.gz i686/glibc-2.15-10-i686.pkg.tar.xz
